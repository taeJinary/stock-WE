# Task Log

## 사용 규칙
- 각 태스크 완료 시점에 `Task.md` 업데이트 여부를 먼저 확인한다.
- 사용자가 승인하면 해당 태스크의 구현 내용을 아래 형식으로 기록한다.

## 기록 형식
### YYYY-MM-DD HH:MM - Task 제목
- 범위:
- 구현 내용:
- 변경 파일:
- 검증:
- 비고:

### 2026-02-11 05:26 - 초기 프로젝트 골격 구축 (1차, 부분 완료)
- 범위:
  - Django 기본 프로젝트를 WEStock 기획/Tech 문서 기준 구조로 확장 시작
  - 설정, 계정/종목/대시보드 앱의 최소 동작 골격 구성
- 구현 내용:
  - `config/settings.py`에 환경변수 로더, 필수 env 검증, `AUTH_USER_MODEL`, Celery/Redis 설정, 보안 관련 기본값 반영
  - `config/urls.py`에 대시보드/종목/브리핑/워치리스트/계정 라우팅 연결
  - `config/celery.py`, `config/__init__.py`로 Celery 앱 로딩 구성
  - `accounts` 앱에 `User(AbstractUser)` 및 `Subscription` 모델/관리자/프로필 뷰 추가
  - `stocks` 앱에 `Stock`, `Price`, `Interest(관심도)` 모델/관리자/목록·상세 뷰 추가
  - `dashboard` 앱에 홈 뷰/URL/기본 템플릿 추가
  - `Dockerfile`, `docker-compose.yml`, `requirements.txt`, `.env.example` 추가
  - `Task.md` 생성
- 변경 파일:
  - `config/settings.py`
  - `config/urls.py`
  - `config/__init__.py`
  - `config/celery.py`
  - `requirements.txt`
  - `Dockerfile`
  - `docker-compose.yml`
  - `.env.example`
  - `apps/dashboard/*`
  - `apps/accounts/*`
  - `apps/stocks/*`
  - `Task.md`
- 검증:
  - 런타임 실행 검증은 아직 미수행
  - 현재 상태에서 `apps.briefing`, `apps.watchlist`, `services/*`, `templates/base.html` 미구현으로 서버 실행 시 ImportError/Template 오류 가능
- 비고:
  - 이전 작업이 사용자 중단으로 멈춰 일부 앱만 생성된 상태
  - 다음 구현에서 누락 모듈을 먼저 생성한 뒤 `python manage.py check` 기준으로 정합성 확인 필요

### 2026-02-11 05:42 - 누락 모듈 보강 및 실행 가능 상태 정합화
- 범위:
  - 누락된 앱/서비스/템플릿/정적 파일을 추가해 기본 라우팅과 렌더링 오류 제거
  - 로컬 의존성 미설치 환경에서도 Django 체크 명령이 동작하도록 설정 보완
- 구현 내용:
  - `briefing`, `watchlist` 앱의 `apps.py`, `models.py`, `views.py`, `urls.py`, `admin.py`, 템플릿 및 `migrations/__init__.py` 추가
  - `services/stock_service.py`, `services/interest_service.py`, `services/news_service.py`, `services/briefing_generator.py` 추가
  - `templates/base.html`, `templates/registration/login.html`, `static/css/style.css`, `static/js/charts.js` 추가
  - `apps/accounts/urls.py`에 `django.contrib.auth.urls` 연결
  - `config/__init__.py`에서 `celery` import 실패 시 안전 처리
  - `config/settings.py`에서 `django_celery_beat` 설치 여부 감지 후 조건부 등록
  - 초기 마이그레이션 파일 생성:
    - `apps/accounts/migrations/0001_initial.py`
    - `apps/stocks/migrations/0001_initial.py`
    - `apps/briefing/migrations/0001_initial.py`
    - `apps/watchlist/migrations/0001_initial.py`
- 변경 파일:
  - `apps/briefing/*`
  - `apps/watchlist/*`
  - `services/*`
  - `templates/base.html`
  - `templates/registration/login.html`
  - `static/css/style.css`
  - `static/js/charts.js`
  - `apps/accounts/urls.py`
  - `config/__init__.py`
  - `config/settings.py`
  - `apps/accounts/migrations/0001_initial.py`
  - `apps/stocks/migrations/0001_initial.py`
  - `apps/briefing/migrations/0001_initial.py`
  - `apps/watchlist/migrations/0001_initial.py`
- 검증:
  - `python manage.py check` 통과
  - `python manage.py makemigrations accounts stocks briefing watchlist` 성공
  - `python manage.py migrate` 성공
- 비고:
  - 현재 서비스 구현은 MVP 스텁 중심이며 외부 API/크롤러/LLM 실제 연동은 후속 태스크에서 고도화 예정

### 2026-02-11 11:55 - Buzz 명칭을 관심도(Interest)로 전환
- 범위:
  - 프로젝트 전반의 `Buzz` 명칭을 `Interest(관심도)`로 통일
  - 코드 식별자와 사용자 노출 문구를 함께 변경
- 구현 내용:
  - 모델 리네이밍: `apps/stocks/models.py`에서 `Buzz` -> `Interest`
  - 역참조 리네이밍: `buzz_records` -> `interest_records`
  - 서비스 리네이밍: `services/buzz_service.py` 제거, `services/interest_service.py` 추가
  - 대시보드/종목 뷰 참조 변경:
    - `apps/dashboard/views.py`에서 `get_top_interest_stocks` 사용
    - `apps/stocks/views.py`에서 `interest_records` 사용
  - 뉴스 서비스 참조 변경: `services/news_service.py`에서 `Interest` 사용
  - 어드민 리네이밍: `BuzzAdmin` -> `InterestAdmin`
  - 템플릿 문구 변경:
    - `apps/dashboard/templates/dashboard/index.html`의 `Buzz` -> `관심도`
    - `apps/stocks/templates/stocks/detail.html`의 섹션명/빈 상태 문구를 관심도 기준으로 변경
  - 데이터 보존형 마이그레이션 작성:
    - `apps/stocks/migrations/0002_rename_interest_model.py` (`RenameModel` + `AlterField`)
    - `apps/stocks/migrations/0003_rename_stocks_buzz_recorde_b89870_idx_stocks_inte_recorde_9ab332_idx.py` (`RenameIndex`)
  - 작업 중 누락 탐지된 `apps/dashboard/migrations/0001_initial.py` 생성
- 변경 파일:
  - `apps/stocks/models.py`
  - `apps/stocks/admin.py`
  - `apps/stocks/views.py`
  - `apps/stocks/templates/stocks/detail.html`
  - `apps/dashboard/views.py`
  - `apps/dashboard/templates/dashboard/index.html`
  - `services/interest_service.py`
  - `services/news_service.py`
  - `services/buzz_service.py` (삭제)
  - `apps/stocks/migrations/0002_rename_interest_model.py`
  - `apps/stocks/migrations/0003_rename_stocks_buzz_recorde_b89870_idx_stocks_inte_recorde_9ab332_idx.py`
  - `apps/dashboard/migrations/0001_initial.py`
  - `Task.md`
- 검증:
  - `python manage.py check` 통과
  - `python manage.py makemigrations` 실행 정상
  - `python manage.py migrate` 적용 완료
- 비고:
  - `Buzz` 문자열은 기존 이력 보존을 위해 초기 마이그레이션(`apps/stocks/migrations/0001_initial.py`)에만 남아 있음

### 2026-02-11 12:13 - OpenAI 제거 및 Gemini API 단일화
- 범위:
  - AI API 스택을 `OpenAI`에서 `Gemini`로 전면 전환
  - 설정, 환경 변수, 브리핑 생성 로직, DB 기본값을 Gemini 기준으로 통일
- 구현 내용:
  - `config/settings.py`에서 `OPENAI_API_KEY` 제거 후 `GEMINI_API_KEY`, `GEMINI_MODEL` 추가
  - `.env.example`를 Gemini 기준으로 갱신 (`GEMINI_API_KEY`, `GEMINI_MODEL`)
  - `requirements.txt`에서 `openai` 의존성 제거
  - `services/briefing_generator.py`를 Gemini REST 호출 로직으로 교체:
    - 입력 데이터 수집(`market_indices`, `top_interest_stocks`, `headlines`)
    - 프롬프트 구성
    - Gemini `generateContent` 호출
    - 실패 시 fallback summary 저장 + 로깅
  - `apps/briefing/models.py`의 `generated_by` 기본값을 `gemini`로 변경
  - 기본값 변경 반영 마이그레이션 생성/적용:
    - `apps/briefing/migrations/0002_alter_dailybriefing_generated_by.py`
- 변경 파일:
  - `config/settings.py`
  - `.env.example`
  - `requirements.txt`
  - `services/briefing_generator.py`
  - `apps/briefing/models.py`
  - `apps/briefing/migrations/0002_alter_dailybriefing_generated_by.py`
  - `Task.md`
- 검증:
  - `python manage.py check` 통과
  - `python manage.py makemigrations briefing` 성공
  - `python manage.py migrate` 적용 완료 (`briefing.0002_alter_dailybriefing_generated_by`)
  - 코드 검색 기준 `openai`/`OPENAI_API_KEY` 참조는 과거 이력용 마이그레이션(`apps/briefing/migrations/0001_initial.py`) 외 제거됨
- 비고:
  - Gemini 호출은 `httpx` 기반 REST 방식으로 구현되어 별도 SDK 의존성 없이 동작

### 2026-02-11 12:31 - 실데이터 파이프라인 1차 구현 (수집→적재→브리핑 체인)
- 범위:
  - 시장 데이터(Alpha Vantage) 수집/적재 로직 구현
  - 관심도(crawler 집계) 수집/적재 로직 구현
  - Celery 체인으로 일일 파이프라인 자동 실행 구조 구현
- 구현 내용:
  - `services/stock_service.py`
    - `INDEX_DEFINITIONS` 도입 (KOSPI/KOSDAQ/S&P500/NASDAQ)
    - `ensure_index_stocks()` 구현 (지수 종목 자동 생성/동기화)
    - `fetch_alpha_vantage_quote()` 구현 (GLOBAL_QUOTE 호출 + 파싱 + 오류 코드 반환)
    - `refresh_market_prices()` 구현 (Price upsert, 실패 목록 포함)
  - `crawler` 모듈 신설:
    - `crawler/base.py`, `crawler/reddit.py`, `crawler/twitter.py`, `crawler/naver.py`, `crawler/news.py`, `crawler/__init__.py`
    - 소스별 mention 수집을 `CrawlRecord`로 표준화
    - `bs4` 미설치 환경 fallback 처리(빈 결과 반환) 적용
  - `services/interest_service.py`
    - `collect_interest_snapshot()` 구현
    - 크롤러 결과를 종목/소스 단위로 집계 후 `Interest` 저장
    - 소스별 수집 통계/총 mention 수를 dict로 반환
  - `apps/briefing/tasks.py`
    - `sync_market_data_task` -> `sync_interest_data_task` -> `generate_daily_briefing_task` 체인 구성
    - `run_daily_pipeline_task()`로 일일 파이프라인 실행 진입점 구현
  - `config/settings.py`
    - `CELERY_BEAT_SCHEDULE` 추가 (`apps.briefing.tasks.run_daily_pipeline_task`, 매일 07:00)
- 변경 파일:
  - `services/stock_service.py`
  - `services/interest_service.py`
  - `apps/briefing/tasks.py`
  - `config/settings.py`
  - `crawler/__init__.py`
  - `crawler/base.py`
  - `crawler/reddit.py`
  - `crawler/twitter.py`
  - `crawler/naver.py`
  - `crawler/news.py`
  - `Task.md`
- 검증:
  - `python manage.py check` 통과
  - 스모크 실행:
    - `ensure_index_stocks` 정상 (`created` 확인)
    - `collect_interest_snapshot` 정상 (`inserted`, `sources` 확인)
    - `refresh_market_prices`는 Alpha Vantage free tier 제한/empty quote로 `partial` 반환(오류 처리 동작 확인)
- 비고:
  - 실데이터 적재 품질은 API 키 권한/호출 제한에 영향받음
  - 현재는 파이프라인 동작성과 실패 내성(부분 성공/오류 수집) 확보에 초점

### 2026-02-11 12:57 - 비용 최적화 반영 (Twitter 제거 + Alpha Vantage 제한 대응)
- 범위:
  - Tech.md 비용 원칙(무료 소스만 사용)에 맞춰 수집 소스를 정리
  - Alpha Vantage free tier 제한(요청 간격/빈 응답) 대응 강화
- 구현 내용:
  - Twitter/Nitter 경로 제거:
    - `crawler/twitter.py` 삭제
    - `crawler/__init__.py`에서 `TwitterCrawler` 제거
    - `services/interest_service.py`의 크롤러 목록에서 Twitter 제거
    - `apps/stocks/models.py`의 `Interest.Source.TWITTER` 제거
  - 데이터 호환 마이그레이션:
    - `apps/stocks/migrations/0004_alter_interest_source.py`
    - 기존 `source='twitter'` 레코드를 `source='news'`로 변환 후 choices 변경
  - Alpha Vantage 제한 대응:
    - `services/stock_service.py`
    - 요청 간 지연(`ALPHA_VANTAGE_MIN_INTERVAL_SEC`) 추가
    - 재시도/백오프(`ALPHA_VANTAGE_MAX_RETRIES`) 추가
    - rate limit 메시지 감지 및 `RATE_LIMIT` 코드 반환
    - 당일 데이터 존재 시 skip 처리(`force=False` 기본)
    - 결과 payload에 `skipped` 필드 추가
- 변경 파일:
  - `crawler/__init__.py`
  - `crawler/twitter.py` (삭제)
  - `services/interest_service.py`
  - `apps/stocks/models.py`
  - `services/stock_service.py`
  - `apps/stocks/migrations/0004_alter_interest_source.py`
  - `Task.md`
- 검증:
  - `python manage.py check` 통과
  - `python manage.py migrate` 통과 (`stocks.0004_alter_interest_source`)
  - 스모크 실행:
    - `collect_interest_snapshot` 정상 (`sources`에 `reddit/naver/news`만 존재)
    - `refresh_market_prices` 정상 실행, 외부 응답 부재 시 `partial/EMPTY_QUOTE`로 안전 처리
- 비고:
  - 과거 마이그레이션 이력(`0001_initial`)의 `twitter` 문자열은 이력 보존 목적

### 2026-02-11 14:15 - 화면 실데이터 연동 1차 (대시보드 HTMX + 종목 차트)
- 범위:
  - 대시보드 실데이터 표시를 partial 구조로 분리하고 HTMX 갱신 추가
  - 종목 상세에 종가+관심도 오버레이 차트 구현
- 구현 내용:
  - `apps/dashboard/views.py`
    - `_dashboard_context()` 도입
    - `market_summary_partial()`, `top_interest_partial()` 추가
    - 빈 데이터 상태 플래그(`has_market_data`, `has_interest_data`) 계산
  - `apps/dashboard/urls.py`
    - `/partials/market-summary/`, `/partials/top-interest/` 라우트 추가
  - `apps/dashboard/templates/dashboard/index.html`
    - 본문을 partial include 방식으로 변경
  - 신규 partial 템플릿 추가:
    - `apps/dashboard/templates/dashboard/_market_summary_panel.html`
    - `apps/dashboard/templates/dashboard/_top_interest_panel.html`
    - 섹션별 `hx-get` 새로고침 버튼 추가
  - `apps/stocks/views.py`
    - 차트용 JSON 데이터 생성(`price_chart_data`, `interest_chart_data`)
    - 관심도 일별 집계(`TruncDate`, `Sum`) 추가
  - `apps/stocks/templates/stocks/detail.html`
    - `canvas#stock-overlay-chart` 추가
    - `json_script` 기반 데이터 주입
    - source 표시를 `row.get_source_display`로 변경
  - `static/js/charts.js`
    - `Chart.js` 오버레이 라인차트 렌더링 구현
    - `DOMContentLoaded`, `htmx:afterSwap` 시 렌더 트리거
  - `templates/base.html`
    - `htmx`, `Chart.js` CDN 추가
    - `login/logout` 링크를 `accounts:login/logout`으로 수정
  - `services/interest_service.py`
    - `get_top_interest_stocks()`에 `hours`, `only_positive` 옵션 추가
  - `static/css/style.css`
    - panel header/refresh 버튼/empty 상태/차트 영역 스타일 추가
- 변경 파일:
  - `apps/dashboard/views.py`
  - `apps/dashboard/urls.py`
  - `apps/dashboard/templates/dashboard/index.html`
  - `apps/dashboard/templates/dashboard/_market_summary_panel.html`
  - `apps/dashboard/templates/dashboard/_top_interest_panel.html`
  - `apps/stocks/views.py`
  - `apps/stocks/templates/stocks/detail.html`
  - `services/interest_service.py`
  - `static/js/charts.js`
  - `templates/base.html`
  - `static/css/style.css`
  - `Task.md`
- 검증:
  - `python manage.py check` 통과
  - 스모크 요청:
    - `/` -> `200`
    - `/stocks/` -> `200`
    - `/partials/market-summary/` -> `200`
    - `/partials/top-interest/` -> `200`
    - `/stocks/<symbol>/` -> `200`
- 비고:
  - 렌더 테스트 중 발견된 `NoReverseMatch('login')`를 `accounts` 네임스페이스 링크로 교정 완료
