{% extends "base.html" %}

{% block title %}{{ stock.symbol }}{% endblock %}

{% block content %}
<section class="panel">
  <h2>{{ stock.symbol }} - {{ stock.name }}</h2>
  <p><strong>Market:</strong> {{ stock.get_market_display }}</p>
  <p><strong>Sector:</strong> {{ stock.sector|default:"-" }}</p>
</section>

<section class="panel">
  <h3>Anomaly Alert</h3>
  {% if stock_anomaly %}
    <div class="anomaly-summary">
      <p class="anomaly-main">
        Recent interest is
        <strong>{{ stock_anomaly.surge_ratio }}x</strong>
        above baseline.
      </p>
      <p class="meta-note">
        recent={{ stock_anomaly.recent_mentions }},
        expected={{ stock_anomaly.expected_mentions }},
        z-score={{ stock_anomaly.z_score }}
      </p>
      <p>
        <span class="severity-badge severity-{{ stock_anomaly.severity }}">
          {{ stock_anomaly.severity|upper }}
        </span>
      </p>
    </div>
  {% else %}
    <p class="empty-note">No abnormal interest surge detected.</p>
  {% endif %}
</section>

{% if request.user.is_authenticated %}
<section class="panel">
  <h3>Watchlists</h3>
  {% if watchlists %}
    <form method="post" action="{% url 'watchlist:add-item' stock.symbol %}" class="watchlist-inline-form">
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.get_full_path }}">
      <label for="watchlist-select">Watchlist</label>
      <select id="watchlist-select" name="watchlist_id">
        {% for watchlist in watchlists %}
          <option value="{{ watchlist.id }}">{{ watchlist.name }}{% if watchlist.is_default %} (default){% endif %}</option>
        {% endfor %}
      </select>
      <input type="text" name="note" maxlength="255" placeholder="Optional note">
      <button type="submit">Add to Watchlist</button>
    </form>

    <ul class="watchlist-chip-list">
      {% for watchlist in watchlists %}
        {% if watchlist.id in watchlist_ids_with_stock %}
          <li>
            <span>{{ watchlist.name }}</span>
            <form method="post" action="{% url 'watchlist:remove-item' stock.symbol %}" class="inline-form">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <input type="hidden" name="watchlist_id" value="{{ watchlist.id }}">
              <button type="submit">Remove</button>
            </form>
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  {% else %}
    <p class="empty-note">No watchlists yet. Create one from the Watchlists page.</p>
  {% endif %}

  {% if watchlist_limit %}
    <p class="meta-note">Free plan limit: up to {{ watchlist_limit }} watchlists.</p>
  {% else %}
    <p class="meta-note">Current plan: unlimited watchlists.</p>
  {% endif %}
</section>
{% else %}
<section class="panel">
  <h3>Watchlists</h3>
  <p><a href="{% url 'accounts:login' %}">Login</a> to add this stock to your watchlists.</p>
</section>
{% endif %}

<section class="panel">
  <h3>Price and Interest Trend</h3>
  <canvas id="stock-overlay-chart" height="120"></canvas>
  {{ price_chart_data|json_script:"price-chart-data" }}
  {{ interest_chart_data|json_script:"interest-chart-data" }}
</section>

<section class="panel">
  <h3>Recent Prices</h3>
  <table>
    <thead>
      <tr>
        <th>Date</th>
        <th>Open</th>
        <th>High</th>
        <th>Low</th>
        <th>Close</th>
        <th>Volume</th>
      </tr>
    </thead>
    <tbody>
      {% for row in prices %}
        <tr>
          <td>{{ row.traded_at }}</td>
          <td>{{ row.open_price }}</td>
          <td>{{ row.high_price }}</td>
          <td>{{ row.low_price }}</td>
          <td>{{ row.close_price }}</td>
          <td>{{ row.volume }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="6">No price data.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="panel">
  <h3>Recent Interest</h3>
  <table>
    <thead>
      <tr>
        <th>Time</th>
        <th>Source</th>
        <th>Mentions</th>
        <th>Sentiment</th>
      </tr>
    </thead>
    <tbody>
      {% for row in interest_records %}
        <tr>
          <td>{{ row.recorded_at }}</td>
          <td>{{ row.get_source_display }}</td>
          <td>{{ row.mentions }}</td>
          <td>{{ row.sentiment_score|default:"-" }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="4">No interest data.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<section class="panel">
  <h3>Related News</h3>
  <ul>
    {% for item in news_items %}
      <li>
        <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer">{{ item.title }}</a>
        {% if item.publisher %}
          <span class="meta-note">({{ item.publisher }})</span>
        {% endif %}
      </li>
    {% empty %}
      <li>No news data.</li>
    {% endfor %}
  </ul>
</section>

<section class="panel">
  <h3>Topic Keyword Cloud</h3>
  {% if topic_cloud %}
    <div class="topic-cloud">
      {% for item in topic_cloud %}
        <span
          class="topic-chip"
          style="--topic-weight: {{ item.weight }}; font-size: {{ item.font_size }}rem;"
          title="{{ item.count }} occurrences"
        >
          {{ item.keyword }}
        </span>
      {% endfor %}
    </div>
  {% else %}
    <p class="empty-note">No keyword data yet.</p>
  {% endif %}
</section>
{% endblock %}
